name: Newsletter Generator

on:
  schedule:
    # Run daily at 8 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Number of days to include in newsletter'
        required: false
        default: '7'
        type: string
      format:
        description: 'Output format'
        required: false
        default: 'pdf'
        type: choice
        options:
        - pdf
        - json
        - markdown

jobs:
  generate-newsletter:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-dateutil jinja2 weasyprint
    
    - name: Generate PDF newsletter
      id: generate_newsletter
      run: |
        python << 'EOF'
        import json
        import os
        import sys
        from datetime import datetime, timezone, timedelta
        from pathlib import Path
        
        # Add current directory to path for imports
        sys.path.insert(0, '.')
        
        # Get parameters
        days_back = int("${{ github.event.inputs.days_back || '7' }}")
        format_type = "${{ github.event.inputs.format || 'pdf' }}"
        
        # Import our PDF generator
        from generate_pdf_newsletter import PDFNewsletterGenerator
        
        # Load articles
        articles_file = 'data/articles.json'
        if not os.path.exists(articles_file):
            print("❌ No articles file found")
            exit(1)
        
        with open(articles_file, 'r') as f:
            articles = json.load(f)
        
        # Load feeds
        feeds_file = 'data/feeds.json'
        feeds = []
        if os.path.exists(feeds_file):
            with open(feeds_file, 'r') as f:
                feeds = json.load(f)
        
        # Filter articles by date
        cutoff_date = datetime.now(timezone.utc) - timedelta(days=days_back)
        recent_articles = []
        
        for article in articles:
            try:
                article_date = datetime.fromisoformat(article['created_at'].replace('Z', '+00:00'))
                if article_date >= cutoff_date:
                    recent_articles.append(article)
            except:
                # If date parsing fails, include the article
                recent_articles.append(article)
        
        # Sort by date (newest first)
        recent_articles.sort(key=lambda x: x['created_at'], reverse=True)
        
        if not recent_articles:
            print("❌ No recent articles found")
            exit(1)
        
        # Create outputs directory
        os.makedirs('outputs/newsletters', exist_ok=True)
        os.makedirs('outputs/api', exist_ok=True)
        
        # Initialize PDF generator
        generator = PDFNewsletterGenerator(
            template_dir='templates',
            output_dir='outputs/newsletters'
        )
        
        # Generate newsletter data
        newsletter_data = generator.generate_newsletter_data(recent_articles, feeds, days_back)
        
        # Save JSON for API compatibility
        json_filename = f"newsletter-{newsletter_data['date']}.json"
        with open(f'outputs/newsletters/{json_filename}', 'w') as f:
            json.dump(newsletter_data, f, indent=2)
        
        # Save as latest newsletter API endpoint
        with open('outputs/api/latest-newsletter.json', 'w') as f:
            json.dump(newsletter_data, f, indent=2)
        
        # Generate PDF
        if format_type == 'pdf':
            try:
                pdf_path = generator.generate_pdf_newsletter(recent_articles, days_back=days_back)
                print(f"✅ PDF newsletter generated: {pdf_path}")
                
                # Also save PDF to api directory for easy access
                pdf_filename = f"newsletter-{newsletter_data['date']}.pdf"
                api_pdf_path = f'outputs/api/{pdf_filename}'
                os.rename(pdf_path, api_pdf_path)
                print(f"📄 PDF available at: {api_pdf_path}")
                
            except Exception as e:
                print(f"❌ Error generating PDF: {e}")
                print("📄 Falling back to JSON format")
        
        # Generate markdown format if requested
        if format_type == 'markdown':
            markdown_content = f"# {newsletter_data['title']}\n\n"
            markdown_content += f"*Generated on {datetime.now(timezone.utc).strftime('%B %d, %Y at %I:%M %p UTC')}*\n\n"
            
            # Add stats
            stats = newsletter_data['stats']
            markdown_content += f"## 📊 Summary\n\n"
            markdown_content += f"- **Articles:** {stats['total_articles']}\n"
            markdown_content += f"- **Feeds:** {stats['active_feeds']} active\n"
            markdown_content += f"- **Reading time:** {stats['total_reading_time']} minutes\n"
            markdown_content += f"- **Words:** {stats['total_words']:,}\n\n"
            
            # Add articles
            if recent_articles:
                markdown_content += f"## 📰 Recent Articles ({len(recent_articles)})\n\n"
                
                for i, article in enumerate(recent_articles[:20], 1):  # Limit to 20
                    priority_emoji = {
                        "high": "🔴",
                        "medium": "🟡",
                        "low": "🟢"
                    }.get(article.get('priority', 'medium'), "⚪")
                    
                    markdown_content += f"{i}. {priority_emoji} **{article['title']}**\n"
                    
                    if article.get('author'):
                        markdown_content += f"   *By {article['author']}*\n"
                    
                    if article.get('source'):
                        markdown_content += f"   📡 Source: {article['source']}\n"
                    
                    markdown_content += f"   📖 {article.get('reading_time', 0)} min • 📅 {article['created_at'][:10]}\n"
                    markdown_content += f"   🔗 [Read article]({article['url']})\n\n"
                
                if len(recent_articles) > 20:
                    markdown_content += f"... and {len(recent_articles) - 20} more articles\n\n"
            
            # Save markdown
            markdown_filename = f"newsletter-{newsletter_data['date']}.md"
            with open(f'outputs/newsletters/{markdown_filename}', 'w') as f:
                f.write(markdown_content)
        
        print(f"🎉 Newsletter generated for {newsletter_data['date']}")
        print(f"📊 Articles: {len(recent_articles)}")
        print(f"📡 Feeds: {len(feeds)}")
        
        # Set outputs using environment files
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"date={newsletter_data['date']}\n")
            f.write(f"articles_count={len(recent_articles)}\n")
            f.write(f"feeds_count={len(feeds)}\n")
        EOF
    
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add all changes
        git add outputs/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "newsletter: generated ${{ steps.generate_newsletter.outputs.date }} PDF briefing with ${{ steps.generate_newsletter.outputs.articles_count }} articles"
          git push
        fi
    
    - name: Summary
      run: |
        echo "## Newsletter Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Date:** ${{ steps.generate_newsletter.outputs.date }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Articles:** ${{ steps.generate_newsletter.outputs.articles_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Feeds:** ${{ steps.generate_newsletter.outputs.feeds_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ✅ Completed" >> $GITHUB_STEP_SUMMARY
